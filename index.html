<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EGT – Pointage</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --card:#121216;
      --card2:#0f0f12;
      --text:#fff;
      --muted:#b7b7c2;
      --line:rgba(255,255,255,.08);
      --blue:#1f86ff;
      --green:#2ecc71;
      --red:#ff4d4f;
      --orange:#ff9f1a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 10% 0%, rgba(31,134,255,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(46,204,113,.10), transparent 55%),
        var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .wrap{ width:min(520px, 100%); }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .inner{ padding:22px; }
    .top{
      display:flex; align-items:center; gap:12px;
      padding:18px 22px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .logo{
      width:34px; height:34px;
      border-radius:10px;
      background: linear-gradient(135deg, rgba(31,134,255,.95), rgba(46,204,113,.85));
      box-shadow: 0 10px 30px rgba(31,134,255,.22);
      display:grid; place-items:center;
      font-weight:800;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .sub{ margin:0; color:var(--muted); font-size:12px; }
    .grid{ display:grid; gap:12px; }
    label{ font-size:12px; color:var(--muted); display:block; margin:0 0 6px; }
    input, select{
      width:100%;
      height:48px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      color:var(--text);
      outline:none;
      padding:0 14px;
      font-size:15px;
    }
    input::placeholder{ color:rgba(255,255,255,.35); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn{
      height:48px;
      border:0;
      border-radius:14px;
      color:#fff;
      font-weight:700;
      letter-spacing:.2px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.blue{ background: linear-gradient(180deg, rgba(31,134,255,1), rgba(31,134,255,.80)); }
    .btn.green{ background: linear-gradient(180deg, rgba(46,204,113,1), rgba(46,204,113,.82)); }
    .btn.gray{ background: rgba(255,255,255,.10); border:1px solid var(--line); }
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .status{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-height:46px;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      margin-top:4px;
      background: rgba(255,255,255,.25);
      flex:0 0 10px;
    }
    .status.ok .dot{ background: var(--green); }
    .status.err .dot{ background: var(--red); }
    .status.warn .dot{ background: var(--orange); }
    .status small{ color:var(--muted); display:block; margin-top:2px; }
    .progressWrap{
      margin-top:10px;
      display:none;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--orange), rgba(255,159,26,.65));
      transition: width .05s linear;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.26);
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
    }
    .sep{ height:1px; background:var(--line); margin:16px 0; }
    .hidden{ display:none !important; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="logo">EGT</div>
      <div>
        <h1>EGT – Pointage</h1>
        <p class="sub">Web (iPhone / Android) – Arrivée + Départ</p>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="viewLogin" class="inner">
      <div class="grid">
        <div>
          <h2 style="margin:0 0 6px;font-size:18px;">Connexion</h2>
          <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.35;">
            Connectez-vous avec votre <b>ID ouvrier</b> (colonne A) et votre mot de passe.
          </p>
        </div>

        <div>
          <label for="loginId">ID ouvrier</label>
          <input id="loginId" inputmode="numeric" placeholder="ex: 1" autocomplete="username" />
        </div>

        <div>
          <label for="loginPass">Mot de passe</label>
          <input id="loginPass" type="password" placeholder="••••" autocomplete="current-password" />
        </div>

        <button id="btnLogin" class="btn blue">Se connecter</button>

        <div id="loginStatus" class="status hidden">
          <div class="dot"></div>
          <div>
            <div id="loginStatusText">—</div>
            <small id="loginStatusSmall">—</small>
          </div>
        </div>

        <div class="hint">
          <b>Astuce iPhone</b> : si la géolocalisation est refusée, allez dans
          <b>Réglages → Safari → Localisation</b> (ou <b>Réglages → Confidentialité → Service de localisation</b>).
        </div>
      </div>
    </div>

    <!-- POINTAGE -->
    <div id="viewPointage" class="inner hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div class="pill">
          <span>Ouvrier :</span>
          <b id="whoName">-</b>
          <span class="mono" id="whoId">(ID -)</span>
        </div>
        <button id="btnLogout" class="btn gray" style="height:38px;border-radius:12px;padding:0 12px;">Déconnexion</button>
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div class="row">
          <div>
            <label>Véhicule arrivée</label>
            <select id="vehArr"></select>
            <div style="margin-top:8px;color:var(--muted);font-size:12px;">
              Plaque arrivée : <b id="plaqueArr">-</b>
            </div>
          </div>
          <div>
            <label>Véhicule départ</label>
            <select id="vehDep" disabled></select>
            <div style="margin-top:8px;color:var(--muted);font-size:12px;">
              Plaque départ : <b id="plaqueDep">-</b>
            </div>
          </div>
        </div>

        <div class="progressWrap" id="progressWrap">
          <div class="progressBar" id="progressBar"></div>
        </div>

        <div class="row">
          <button id="btnArrivee" class="btn blue">Arrivée (maintenir 3s)</button>
          <button id="btnDepart" class="btn green">Départ (maintenir 3s)</button>
        </div>

        <div id="status" class="status">
          <div class="dot"></div>
          <div>
            <div id="statusText">Prêt.</div>
            <small id="statusSmall">Sélectionne les véhicules puis valide l’arrivée.</small>
          </div>
        </div>

        <div class="hint">
          La ligne est envoyée au serveur <b>uniquement au départ</b> (arrivée stockée localement entre-temps).
          <br/>Si le serveur répond <b>DUPLICATE_POINTAGE</b>, la journée est verrouillée (“déjà envoyé”).
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // =====================================================
  // CONFIG
  // =====================================================
  const API_URL = "https://script.google.com/macros/s/AKfycbyAGwr3dCcXbf9XcuaovU2mtRGtW8aQFHY88iL8hvCMmled1YmOoOivb2ITTr8toYBL/exec";
  const HOLD_MS = 3000;

  // Storage keys
  const LS_USER = "egt_user_v1";             // {id, nom, adresse}
  const LS_ARR  = "egt_arrivee_v1";          // arrival payload stored until depart
  const LS_SENT = "egt_sent_v1";             // { "<id>|<yyyy-mm-dd>": true }

  // =====================================================
  // DOM
  // =====================================================
  const viewLogin = document.getElementById("viewLogin");
  const viewPointage = document.getElementById("viewPointage");

  const loginId = document.getElementById("loginId");
  const loginPass = document.getElementById("loginPass");
  const btnLogin = document.getElementById("btnLogin");
  const loginStatus = document.getElementById("loginStatus");
  const loginStatusText = document.getElementById("loginStatusText");
  const loginStatusSmall = document.getElementById("loginStatusSmall");

  const whoName = document.getElementById("whoName");
  const whoId = document.getElementById("whoId");
  const btnLogout = document.getElementById("btnLogout");

  const vehArr = document.getElementById("vehArr");
  const vehDep = document.getElementById("vehDep");
  const plaqueArr = document.getElementById("plaqueArr");
  const plaqueDep = document.getElementById("plaqueDep");

  const btnArrivee = document.getElementById("btnArrivee");
  const btnDepart = document.getElementById("btnDepart");

  const statusBox = document.getElementById("status");
  const statusText = document.getElementById("statusText");
  const statusSmall = document.getElementById("statusSmall");

  const progressWrap = document.getElementById("progressWrap");
  const progressBar = document.getElementById("progressBar");

  // In-memory state
  let currentUser = null;
  let vehicules = []; // [{id, nom, plaque, ...}]
  let holdingTimer = null;
  let holdingStart = 0;
  let holdingWhich = null; // "arr" or "dep"
  let isSending = false;

  // =====================================================
  // Helpers
  // =====================================================
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function timeHM(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function setStatus(type, main, small=""){
    statusBox.classList.remove("ok","err","warn");
    if(type) statusBox.classList.add(type);
    statusText.textContent = main || "";
    statusSmall.textContent = small || "";
  }
  function setLoginStatus(type, main, small=""){
    loginStatus.classList.remove("hidden","ok","err","warn");
    loginStatus.classList.remove("ok","err","warn");
    if(type) loginStatus.classList.add(type);
    loginStatusText.textContent = main || "";
    loginStatusSmall.textContent = small || "";
  }
  function clearLoginStatus(){
    loginStatus.classList.add("hidden");
  }

  function lsGet(key){
    try { return JSON.parse(localStorage.getItem(key) || "null"); } catch(e){ return null; }
  }
  function lsSet(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
  function lsDel(key){
    localStorage.removeItem(key);
  }

  // JSONP GET (bypass CORS for GitHub Pages)
  function jsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const url = new URL(API_URL);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, v));

      url.searchParams.set("callback", cb);

      const script = document.createElement("script");
      script.src = url.toString();
      script.async = true;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout réseau"));
      }, 20000);

      function cleanup(){
        clearTimeout(timeout);
        delete window[cb];
        script.remove();
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        cleanup();
        reject(new Error("Erreur réseau / script"));
      };

      document.body.appendChild(script);
    });
  }

  function getSelectedVeh(selectEl){
    const idx = selectEl.selectedIndex;
    if(idx < 0 || idx >= vehicules.length) return null;
    return vehicules[idx];
  }

  function refreshPlaques(){
    const a = getSelectedVeh(vehArr);
    const d = getSelectedVeh(vehDep);
    plaqueArr.textContent = a?.plaque || "-";
    plaqueDep.textContent = d?.plaque || "-";
  }

  function dayKey(){
    if(!currentUser?.id) return null;
    return `${currentUser.id}|${todayISO()}`;
  }

  function isDaySent(){
    const sent = lsGet(LS_SENT) || {};
    const key = dayKey();
    return key ? !!sent[key] : false;
  }

  function markDaySent(){
    const sent = lsGet(LS_SENT) || {};
    const key = dayKey();
    if(key){
      sent[key] = true;
      lsSet(LS_SENT, sent);
    }
  }

  function lockUI(){
    // if already sent today -> disable everything
    const sent = isDaySent();
    const arrSaved = lsGet(LS_ARR);

    if(sent){
      vehArr.disabled = true;
      vehDep.disabled = true;
      btnArrivee.disabled = true;
      btnDepart.disabled = true;
      setStatus("ok", "Pointage déjà envoyé aujourd’hui ✔", "Rien à faire.");
      return;
    }

    if(arrSaved){
      // arrival done locally
      vehArr.disabled = true;
      btnArrivee.disabled = true;

      vehDep.disabled = false;
      btnDepart.disabled = false;

      setStatus("warn", "Arrivée enregistrée (local).", "Valide le départ pour envoyer.");
    } else {
      vehArr.disabled = false;
      btnArrivee.disabled = false;

      vehDep.disabled = true;
      btnDepart.disabled = false; // bouton gère message
      setStatus("", "Prêt.", "Sélectionne les véhicules puis valide l’arrivée.");
    }
  }

  // =====================================================
  // GEOLOCATION
  // =====================================================
  function getLocation(){
    return new Promise((resolve, reject) => {
      if(!navigator.geolocation){
        reject(new Error("Géolocalisation non supportée"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        (err) => {
          let msg = "Localisation refusée";
          if(err && err.message) msg = err.message;
          reject(new Error(msg));
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    });
  }

  // =====================================================
  // API calls
  // =====================================================
  async function apiLogin(id, password){
    return await jsonp({ type:"login", id, password });
  }
  async function apiVehicules(){
    return await jsonp({ type:"vehicule" });
  }
  async function apiSendPointage(payloadObj){
    // server expects GET type=pointage_web&payload=<encoded json>
    const payload = encodeURIComponent(JSON.stringify(payloadObj));
    return await jsonp({ type:"pointage_web", payload });
  }

  // =====================================================
  // HOLD BUTTON (3 seconds)
  // =====================================================
  function startHold(which){
    if(isSending) return;

    // guard
    if(which === "dep"){
      const arr = lsGet(LS_ARR);
      if(!arr){
        setStatus("warn", "Commence par valider l’arrivée.", "Arrivée manquante.");
        return;
      }
      if(isDaySent()){
        setStatus("ok", "Déjà envoyé aujourd’hui ✔", "Journée verrouillée.");
        return;
      }
    }
    if(which === "arr"){
      if(isDaySent()){
        setStatus("ok", "Déjà envoyé aujourd’hui ✔", "Journée verrouillée.");
        return;
      }
      if(lsGet(LS_ARR)){
        setStatus("warn", "Arrivée déjà enregistrée.", "Valide le départ.");
        return;
      }
    }

    holdingWhich = which;
    holdingStart = Date.now();
    progressWrap.style.display = "block";
    progressBar.style.width = "0%";

    // tick animation
    const tick = () => {
      const elapsed = Date.now() - holdingStart;
      const pct = Math.min(100, (elapsed / HOLD_MS) * 100);
      progressBar.style.width = pct + "%";
      if(elapsed >= HOLD_MS){
        finishHold();
      } else {
        holdingTimer = requestAnimationFrame(tick);
      }
    };
    holdingTimer = requestAnimationFrame(tick);
  }

  function cancelHold(){
    if(holdingTimer){
      cancelAnimationFrame(holdingTimer);
      holdingTimer = null;
    }
    progressBar.style.width = "0%";
    progressWrap.style.display = "none";
    holdingWhich = null;
  }

  async function finishHold(){
    if(holdingTimer){
      cancelAnimationFrame(holdingTimer);
      holdingTimer = null;
    }
    progressBar.style.width = "100%";
    setTimeout(() => { progressWrap.style.display = "none"; }, 120);

    const which = holdingWhich;
    holdingWhich = null;

    if(which === "arr") await doArrivee();
    if(which === "dep") await doDepart();
  }

  function bindHold(btn, which){
    const down = (e) => { e.preventDefault(); startHold(which); };
    const up   = (e) => { e.preventDefault(); if(holdingWhich){ setStatus("warn","Appui trop court.", "Maintiens 3 secondes."); } cancelHold(); };

    // pointer events (works on iOS/Android/desktop)
    btn.addEventListener("pointerdown", down);
    btn.addEventListener("pointerup", up);
    btn.addEventListener("pointercancel", up);
    btn.addEventListener("pointerleave", up);
  }

  // =====================================================
  // ARRIVEE / DEPART logic
  // =====================================================
  async function doArrivee(){
    if(isSending) return;
    isSending = true;
    try{
      setStatus("", "Localisation de l’arrivée…", "Active le GPS si nécessaire.");

      const vA = getSelectedVeh(vehArr);
      if(!vA){
        setStatus("err","Aucun véhicule sélectionné.", "Choisis un véhicule arrivée.");
        return;
      }

      const loc = await getLocation();

      const arrPayload = {
        ouvrier_id: String(currentUser.id),
        ouvrier_nom: String(currentUser.nom || ""),
        ouvrier_adresse: String(currentUser.adresse || ""),
        date_jour: todayISO(),
        heure_arrivee: timeHM(),
        lat_arrivee: loc.lat,
        lon_arrivee: loc.lon,
        vehicule_arrivee_nom: vA.nom || "",
        vehicule_arrivee_plaque: vA.plaque || "",
        // compat
        vehicule_nom: vA.nom || "",
        vehicule_plaque: vA.plaque || ""
      };

      lsSet(LS_ARR, arrPayload);

      setStatus("ok", "Arrivée validée ✔", "Véhicule arrivée figé. Fais le départ pour envoyer.");
      lockUI();

    }catch(err){
      setStatus("err", "Erreur arrivée", err.message || String(err));
    }finally{
      isSending = false;
    }
  }

  async function doDepart(){
    if(isSending) return;
    isSending = true;
    try{
      const arr = lsGet(LS_ARR);
      if(!arr){
        setStatus("warn","Arrivée manquante.", "Revalide l’arrivée.");
        return;
      }

      setStatus("", "Localisation du départ…", "Active le GPS si nécessaire.");

      const vD = getSelectedVeh(vehDep);
      if(!vD){
        setStatus("err","Aucun véhicule sélectionné.", "Choisis un véhicule départ.");
        return;
      }

      const loc = await getLocation();

      const payload = {
        ...arr,
        heure_depart: timeHM(),
        lat_depart: loc.lat,
        lon_depart: loc.lon,
        vehicule_depart_nom: vD.nom || "",
        vehicule_depart_plaque: vD.plaque || ""
      };

      setStatus("", "Envoi du pointage…", "Connexion au serveur.");

      const res = await apiSendPointage(payload);

      // res: {status, code, message, data}
      const st = (res && (res.status || "")).toLowerCase();
      const code = (res && (res.code || "")).toUpperCase();
      const msg = (res && (res.message || "")) || "";

      if(st === "duplicate" || code === "DUPLICATE_POINTAGE"){
        // serveur dit déjà enregistré
        markDaySent();
        lsDel(LS_ARR);
        setStatus("ok", "Déjà envoyé aujourd’hui ✔", "Journée verrouillée.");
        lockUI();
        return;
      }

      if(st !== "ok"){
        setStatus("err", "Erreur serveur", msg || ("Code: " + code));
        return;
      }

      // OK
      markDaySent();
      lsDel(LS_ARR);
      setStatus("ok", "Pointage envoyé ✔", "Merci.");
      lockUI();

    }catch(err){
      setStatus("err", "Erreur départ / envoi", err.message || String(err));
    }finally{
      isSending = false;
    }
  }

  // =====================================================
  // UI flow
  // =====================================================
  async function initAfterLogin(){
    whoName.textContent = currentUser.nom || "-";
    whoId.textContent = `(ID ${currentUser.id || "-"})`;

    // load vehicules
    setStatus("", "Chargement des véhicules…", "");
    try{
      const res = await apiVehicules();
      if((res.status || "").toLowerCase() !== "ok"){
        throw new Error(res.message || "Erreur chargement véhicules");
      }
      vehicules = res.data || [];
      vehArr.innerHTML = "";
      vehDep.innerHTML = "";
      vehicules.forEach(v => {
        const optA = document.createElement("option");
        optA.textContent = v.nom || "-";
        vehArr.appendChild(optA);

        const optD = document.createElement("option");
        optD.textContent = v.nom || "-";
        vehDep.appendChild(optD);
      });

      refreshPlaques();

      // if arrival saved -> preselect that arrival vehicle
      const arr = lsGet(LS_ARR);
      if(arr?.vehicule_arrivee_nom){
        const idx = vehicules.findIndex(v => String(v.nom).toLowerCase() === String(arr.vehicule_arrivee_nom).toLowerCase());
        if(idx >= 0) vehArr.selectedIndex = idx;
      }

      refreshPlaques();
      lockUI();

    }catch(err){
      setStatus("err", "Impossible de charger les véhicules", err.message || String(err));
    }
  }

  function showPointage(){
    viewLogin.classList.add("hidden");
    viewPointage.classList.remove("hidden");
  }
  function showLogin(){
    viewPointage.classList.add("hidden");
    viewLogin.classList.remove("hidden");
  }

  function logout(){
    lsDel(LS_USER);
    currentUser = null;
    // On ne supprime pas LS_ARR / LS_SENT ici (si tu veux garder)
    showLogin();
    clearLoginStatus();
  }

  // =====================================================
  // Events
  // =====================================================
  vehArr.addEventListener("change", refreshPlaques);
  vehDep.addEventListener("change", refreshPlaques);

  btnLogout.addEventListener("click", logout);

  btnLogin.addEventListener("click", async () => {
    const id = (loginId.value || "").trim();
    const pass = (loginPass.value || "").trim();
    clearLoginStatus();

    if(!id || !pass){
      setLoginStatus("warn", "Champs manquants", "Saisis ID ouvrier + mot de passe.");
      return;
    }

    btnLogin.disabled = true;
    setLoginStatus("", "Connexion…", "Vérification des identifiants.");

    try{
      const res = await apiLogin(id, pass);

      if((res.status || "").toLowerCase() !== "ok"){
        setLoginStatus("err", "Identifiants incorrects", res.message || "");
        btnLogin.disabled = false;
        return;
      }

      currentUser = res.data || { id, nom:"", adresse:"" };
      lsSet(LS_USER, currentUser);

      setLoginStatus("ok", "Connexion OK ✔", "");
      showPointage();
      await initAfterLogin();

    }catch(err){
      setLoginStatus("err", "Erreur connexion", err.message || String(err));
    }finally{
      btnLogin.disabled = false;
    }
  });

  // bind hold buttons
  bindHold(btnArrivee, "arr");
  bindHold(btnDepart, "dep");

  // =====================================================
  // Boot: auto login if stored
  // =====================================================
  (function boot(){
    const u = lsGet(LS_USER);
    if(u && u.id){
      currentUser = u;
      showPointage();
      initAfterLogin();
    } else {
      showLogin();
    }
  })();
</script>
</body>
</html>
