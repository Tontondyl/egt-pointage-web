<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EGT Wagner - Pointage</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#121212; color:#fff; margin:0; padding:16px;}
    .card{max-width:520px; margin:0 auto; background:#1c1c1c; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35);}
    h1{font-size:18px; margin:0 0 10px;}
    label{display:block; font-size:13px; color:#bbb; margin:12px 0 6px;}
    input,select,button{width:100%; box-sizing:border-box; padding:12px; border-radius:10px; border:1px solid #333; background:#101010; color:#fff; font-size:16px;}
    button{border:0; cursor:pointer;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnBlue{background:#1E88E5;}
    .btnGreen{background:#43A047;}
    .btnGray{background:#2b2b2b; color:#bbb;}
    .status{margin-top:12px; color:#ddd; font-size:14px; min-height:20px;}
    .small{font-size:12px;color:#aaa;margin-top:6px;}
    .hidden{display:none;}
    .divider{height:1px;background:#2a2a2a;margin:14px 0;}
  </style>
</head>
<body>
  <div class="card">
    <h1>Pointage (iPhone/Web)</h1>

    <!-- LOGIN -->
    <div id="loginBox">
      <label>ID ouvrier</label>
      <input id="inpId" placeholder="ex: 12" />

      <label>Mot de passe</label>
      <input id="inpPwd" type="password" placeholder="••••••" />

      <button class="btnBlue" id="btnLogin">Se connecter</button>
      <div class="status" id="statusLogin"></div>
      <div class="small">Astuce iPhone : Safari → Partager → “Sur l’écran d’accueil”</div>
    </div>

    <!-- APP -->
    <div id="appBox" class="hidden">
      <div class="small" id="who"></div>
      <div class="divider"></div>

      <label>Véhicule arrivée</label>
      <select id="vehArr"></select>
      <div class="small" id="plaqueArr">Plaque arrivée : -</div>

      <label>Véhicule départ</label>
      <select id="vehDep" disabled></select>
      <div class="small" id="plaqueDep">Plaque départ : -</div>

      <div class="divider"></div>

      <div class="row">
        <button class="btnBlue" id="btnArrivee">Arrivée (maintenir 3s)</button>
        <button class="btnGreen" id="btnDepart">Départ (maintenir 3s)</button>
      </div>

      <div class="status" id="statusApp"></div>
      <div class="small" id="debug"></div>
    </div>
  </div>

<script>
  // =======================
  // CONFIG : Mets ton URL /exec ici
  // =======================
  const API_URL = "https://script.google.com/macros/s/XXXX/exec";

  // =======================
  // STATE
  // =======================
  let user = null;           // {id, nom, adresse}
  let vehicules = [];        // {id, nom, plaque}
  let pointage = null;       // JSON arrivée persisté localStorage

  const LS_USER = "egt_user";
  const LS_POINTAGE = "egt_pointage";

  // =======================
  // JSONP helper
  // =======================
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{
        resolve(data);
        cleanup();
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      script.onerror = ()=>{ reject(new Error("JSONP error")); cleanup(); };

      function cleanup(){
        delete window[cb];
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }
      document.body.appendChild(script);
    });
  }

  function setStatus(el, msg){ el.textContent = msg || ""; }

  function todayStr(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function timeStr(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mi}`;
  }

  // =======================
  // UI refs
  // =======================
  const loginBox = document.getElementById("loginBox");
  const appBox = document.getElementById("appBox");
  const statusLogin = document.getElementById("statusLogin");
  const statusApp = document.getElementById("statusApp");
  const who = document.getElementById("who");

  const inpId = document.getElementById("inpId");
  const inpPwd = document.getElementById("inpPwd");
  const btnLogin = document.getElementById("btnLogin");

  const vehArr = document.getElementById("vehArr");
  const vehDep = document.getElementById("vehDep");
  const plaqueArr = document.getElementById("plaqueArr");
  const plaqueDep = document.getElementById("plaqueDep");

  const btnArrivee = document.getElementById("btnArrivee");
  const btnDepart  = document.getElementById("btnDepart");

  // =======================
  // Restore
  // =======================
  function restore(){
    try{
      const u = localStorage.getItem(LS_USER);
      if(u) user = JSON.parse(u);
      const p = localStorage.getItem(LS_POINTAGE);
      if(p) pointage = JSON.parse(p);
    }catch(e){}
  }

  function showApp(){
    loginBox.classList.add("hidden");
    appBox.classList.remove("hidden");
    who.textContent = `Connecté : ${user.nom} (ID ${user.id})`;
  }

  function showLogin(){
    loginBox.classList.remove("hidden");
    appBox.classList.add("hidden");
  }

  // =======================
  // Vehicles
  // =======================
  async function loadVehicules(){
    setStatus(statusApp, "Chargement des véhicules...");
    const url = `${API_URL}?type=vehicule`;
    const res = await jsonp(url);
    if(res.status !== "ok") throw new Error(res.message || "Erreur véhicules");

    vehicules = res.data || [];
    vehArr.innerHTML = "";
    vehDep.innerHTML = "";

    for(const v of vehicules){
      const o1 = document.createElement("option");
      o1.value = v.id; o1.textContent = v.nom;
      vehArr.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = v.id; o2.textContent = v.nom;
      vehDep.appendChild(o2);
    }

    // default select
    if(vehicules.length){
      vehArr.value = vehicules[0].id;
      vehDep.value = vehicules[0].id;
      updatePlaques();
    }

    // si arrivée déjà enregistrée => figer arrivée et activer départ
    if(pointage && pointage.arriveeValidee){
      vehArr.disabled = true;
      btnArrivee.disabled = true;
      vehDep.disabled = false;
      setStatus(statusApp, "Arrivée restaurée (tu peux faire le départ).");
    }else{
      vehArr.disabled = false;
      btnArrivee.disabled = false;
      vehDep.disabled = true;
    }
  }

  function findVehById(id){
    return vehicules.find(v=>String(v.id)===String(id));
  }

  function updatePlaques(){
    const vA = findVehById(vehArr.value);
    const vD = findVehById(vehDep.value);
    plaqueArr.textContent = "Plaque arrivée : " + (vA ? vA.plaque : "-");
    plaqueDep.textContent = "Plaque départ : " + (vD ? vD.plaque : "-");
  }

  vehArr.addEventListener("change", updatePlaques);
  vehDep.addEventListener("change", updatePlaques);

  // =======================
  // Geolocation
  // =======================
  function getLocation(){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error("GPS indisponible"));
      navigator.geolocation.getCurrentPosition(
        pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
        err => reject(new Error("GPS refusé / indisponible")),
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    });
  }

  // =======================
  // Pointage submit (JSONP)
  // =======================
  async function submitPointage(data){
    const payload = encodeURIComponent(JSON.stringify(data));
    const url = `${API_URL}?type=pointage_web&payload=${payload}`;
    return await jsonp(url);
  }

  // =======================
  // Hold 3s helper
  // =======================
  function hold3s(button, action){
    let timer = null;
    let holding = false;

    const start = ()=>{
      if(holding) return;
      holding = true;
      setStatus(statusApp, "Maintiens 3 secondes...");
      timer = setTimeout(async ()=>{
        timer = null;
        try{
          await action();
        }catch(e){
          setStatus(statusApp, "Erreur : " + e.message);
        }finally{
          holding = false;
        }
      }, 3000);
    };

    const cancel = ()=>{
      if(timer){
        clearTimeout(timer);
        timer = null;
        setStatus(statusApp, "Appui trop court, recommence (3 s).");
      }
      holding = false;
    };

    button.addEventListener("touchstart", start, {passive:true});
    button.addEventListener("touchend", cancel);
    button.addEventListener("touchcancel", cancel);

    // aussi souris (PC)
    button.addEventListener("mousedown", start);
    button.addEventListener("mouseup", cancel);
    button.addEventListener("mouseleave", cancel);
  }

  // =======================
  // Actions
  // =======================
  async function doArrivee(){
    if(pointage && pointage.arriveeValidee){
      setStatus(statusApp, "Arrivée déjà validée.");
      return;
    }

    setStatus(statusApp, "GPS arrivée...");
    const gps = await getLocation();

    const vA = findVehById(vehArr.value);
    const data = {
      ouvrier_id: user.id,
      ouvrier_nom: user.nom,
      ouvrier_adresse: user.adresse || "",
      date_jour: todayStr(),
      heure_arrivee: timeStr(),
      lat_arrivee: gps.lat,
      lon_arrivee: gps.lon,
      vehicule_arrivee_nom: vA ? vA.nom : "",
      vehicule_arrivee_plaque: vA ? vA.plaque : ""
    };

    // On ne l’envoie PAS tout de suite si tu veux garder la logique Android (envoi au départ)
    // Ici, on garde pareil : on stocke seulement l’arrivée.
    pointage = { arriveeValidee:true, data };
    localStorage.setItem(LS_POINTAGE, JSON.stringify(pointage));

    vehArr.disabled = true;
    btnArrivee.disabled = true;
    vehDep.disabled = false;

    setStatus(statusApp, "Arrivée validée ✔ (véhicule arrivée figé)");
  }

  async function doDepart(){
    if(!pointage || !pointage.arriveeValidee){
      setStatus(statusApp, "Commence par valider l'arrivée.");
      return;
    }

    setStatus(statusApp, "GPS départ...");
    const gps = await getLocation();

    const vD = findVehById(vehDep.value);

    // compléter et envoyer
    const data = Object.assign({}, pointage.data, {
      heure_depart: timeStr(),
      lat_depart: gps.lat,
      lon_depart: gps.lon,
      vehicule_depart_nom: vD ? vD.nom : "",
      vehicule_depart_plaque: vD ? vD.plaque : ""
    });

    setStatus(statusApp, "Envoi...");
    const res = await submitPointage(data);

    if(res.status === "duplicate" || res.code === "DUPLICATE_POINTAGE"){
      setStatus(statusApp, "Déjà envoyé aujourd'hui ✔");
    }else if(res.status !== "ok"){
      throw new Error(res.message || "Erreur serveur");
    }else{
      setStatus(statusApp, "Pointage envoyé ✔");
    }

    // reset journée côté web
    pointage = null;
    localStorage.removeItem(LS_POINTAGE);

    vehArr.disabled = false;
    btnArrivee.disabled = false;
    vehDep.disabled = true;

    // Option: tu peux aussi déconnecter automatiquement
  }

  // =======================
  // Login
  // =======================
  btnLogin.addEventListener("click", async ()=>{
    try{
      setStatus(statusLogin, "Connexion...");
      const id = inpId.value.trim();
      const pwd = inpPwd.value.trim();
      if(!id || !pwd){ setStatus(statusLogin, "ID et mot de passe requis."); return; }

      const url = `${API_URL}?type=login&id=${encodeURIComponent(id)}&password=${encodeURIComponent(pwd)}`;
      const res = await jsonp(url);

      if(res.status !== "ok"){
        setStatus(statusLogin, res.message || "Erreur login");
        return;
      }

      user = res.data;
      localStorage.setItem(LS_USER, JSON.stringify(user));
      showApp();
      await loadVehicules();

    }catch(e){
      setStatus(statusLogin, "Erreur : " + e.message);
    }
  });

  // setup holds
  hold3s(btnArrivee, doArrivee);
  hold3s(btnDepart, doDepart);

  // boot
  restore();
  if(user){
    showApp();
    loadVehicules().catch(e=>setStatus(statusApp, "Erreur : "+e.message));
  }else{
    showLogin();
  }
</script>
</body>
</html>
